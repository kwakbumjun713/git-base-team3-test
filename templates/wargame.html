{% extends "base.html" %}

{% block title %}ì›Œê²Œì„ | HSpace{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wargame.css') }}">
{% endblock %}

{% block content %}
<section class="wargame-hero">
    <div class="hero-copy">
        <p class="eyebrow">ì‹¤ì‹œê°„ ì›Œê²Œì„</p>
        <h1>ì§€ê¸ˆ ë°”ë¡œ ìš°ì£¼ ë³´ì•ˆ ì„ë¬´ì— íˆ¬ì…ë˜ì„¸ìš”.</h1>
        <p>
            ê¸°ì´ˆë¶€í„° ê³ ê¸‰ê¹Œì§€ ëª¨ë“  ë‚œì´ë„ì˜ ë¬¸ì œë¥¼ í’€ê³ , ì§ì ‘ ë§Œë“  ë¬¸ì œë¥¼ ì»¤ë®¤ë‹ˆí‹°ì— ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            ìƒì‹œ ì˜¤í”ˆëœ ì‹œì¦Œ ë³´ë“œì—ì„œ ì‹¤ë ¥ì„ ì¦ëª…í•´ë³´ì„¸ìš”.
        </p>
        <div class="hero-actions">
            <a href="#challenge-grid" class="primary">ë¬¸ì œ í’€ê¸°</a>
            <a href="#create-section" class="ghost">ë¬¸ì œ ì—…ë¡œë“œ</a>
        </div>
    </div>
    <div class="hero-featured">
        {% if featured %}
        <h3>Featured Challenge</h3>
        <p class="difficulty-tag">{{ featured.difficulty }}</p>
        <h2>{{ featured.title }}</h2>
        <p>{{ featured.summary }}</p>
        <div class="meta">
            <span>#{{ featured.category }}</span>
            <span>{{ featured.solved_count }} solved</span>
        </div>
        {% else %}
        <h2>ê³§ ê³µê°œë©ë‹ˆë‹¤.</h2>
        <p>ì²« ë¬¸ì œë¥¼ ë§Œë“¤ì–´ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”.</p>
        {% endif %}
    </div>
</section>

<section class="wargame-stats">
    <article>
        <span class="label">ë“±ë¡ëœ ë¬¸ì œ</span>
        <strong>{{ stats.total_challenges }}</strong>
    </article>
    <article>
        <span class="label">ì»¤ë®¤ë‹ˆí‹° ë¬¸ì œ</span>
        <strong>{{ stats.community_count }}</strong>
    </article>
    <article>
        <span class="label">ì •ë‹µ ì œì¶œ</span>
        <strong>{{ stats.solved_total }}</strong>
    </article>
</section>

<section class="wargame-body">
    <div class="wargame-main">
        <header class="section-header">
            <div>
                <p class="eyebrow">Live Challenges</p>
                <h2>ì‹¤ì‹œê°„ ì›Œê²Œì„ ë¬¸ì œë“¤</h2>
            </div>
            <p>FLAG í˜•ì‹ì€ ê¸°ë³¸ì ìœ¼ë¡œ <code>FLAG&#123;...&#125;</code> ì…ë‹ˆë‹¤.</p>
        </header>

        <form class="challenge-filters" method="get" action="{{ url_for('wargame.dashboard') }}">
            <label>
                <span>ê²€ìƒ‰</span>
                <input type="text" name="search" placeholder="ì œëª© ë˜ëŠ” ì„¤ëª…" value="{{ filters.search }}">
            </label>
            <label>
                <span>ë‚œì´ë„</span>
                <select name="difficulty">
                    <option value="all" {% if filters.difficulty == 'all' %}selected{% endif %}>ì „ì²´</option>
                    <option value="ì´ˆê¸‰" {% if filters.difficulty == 'ì´ˆê¸‰' %}selected{% endif %}>ì´ˆê¸‰</option>
                    <option value="ì¤‘ê¸‰" {% if filters.difficulty == 'ì¤‘ê¸‰' %}selected{% endif %}>ì¤‘ê¸‰</option>
                    <option value="ê³ ê¸‰" {% if filters.difficulty == 'ê³ ê¸‰' %}selected{% endif %}>ê³ ê¸‰</option>
                </select>
            </label>
            <label>
                <span>ì¹´í…Œê³ ë¦¬</span>
                <select name="category">
                    <option value="all" {% if filters.category == 'all' %}selected{% endif %}>ì „ì²´</option>
                    {% for category in categories %}
                    <option value="{{ category }}" {% if filters.category == category %}selected{% endif %}>{{ category }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                <span>ì •ë ¬</span>
                <select name="sort">
                    <option value="newest" {% if filters.sort == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
                    <option value="popular" {% if filters.sort == 'popular' %}selected{% endif %}>ì¸ê¸°ìˆœ</option>
                    <option value="reward" {% if filters.sort == 'reward' %}selected{% endif %}>í¬ì¸íŠ¸ìˆœ</option>
                    <option value="oldest" {% if filters.sort == 'oldest' %}selected{% endif %}>ì˜¤ë˜ëœìˆœ</option>
                </select>
            </label>
            <div class="filter-actions">
                <button type="submit">í•„í„° ì ìš©</button>
                {% if filters.difficulty != 'all' or filters.category != 'all' or filters.search or filters.sort != 'newest' %}
                <a class="reset" href="{{ url_for('wargame.dashboard') }}">ì´ˆê¸°í™”</a>
                {% endif %}
            </div>
        </form>

        <div class="challenge-grid" id="challenge-grid">
            {% for challenge in challenges %}
            <article class="challenge-card diff-{{ challenge.difficulty }}">
                <header>
                    <span class="difficulty">{{ challenge.difficulty }}</span>
                    <h3>{{ challenge.title }}</h3>
                    <p>{{ challenge.summary }}</p>
                </header>
                <div class="challenge-meta">
                    <span>#{{ challenge.category }}</span>
                    <span>{{ challenge.solved_count }} solved</span>
                    {% if challenge.is_community %}
                    <span>by {{ challenge.author_name }}</span>
                    {% endif %}
                </div>
                {% if challenge.attachment_path %}
                <a class="download-badge" href="{{ url_for('static', filename=challenge.attachment_path) }}" download>
                    ìë£Œ ë‹¤ìš´ë¡œë“œ
                </a>
                {% endif %}
                {% if challenge.hint %}
                <p class="hint">ğŸ’¡ Hint: {{ challenge.hint }}</p>
                {% endif %}
                <form method="post" action="{{ url_for('wargame.attempt_challenge') }}" class="flag-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="challenge_id" value="{{ challenge.id }}">
                    <input type="text" name="flag" placeholder="FLAG{...}" required>
                    <button type="submit">ì œì¶œ</button>
                </form>
                {% if not g.user %}
                <p class="login-hint">ë¡œê·¸ì¸ í›„ ì œì¶œí•˜ë©´ ê¸°ë¡ì— ë°˜ì˜ë©ë‹ˆë‹¤.</p>
                {% endif %}
            </article>
            {% else %}
            <p class="empty-state">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
            {% endfor %}
        </div>
    </div>

    <aside class="wargame-sidebar">
        {% if user_stats %}
        <section class="card">
            <h3>ë‚´ ì§„í–‰ìƒí™©</h3>
            <ul class="progress-metrics">
                <li>
                    <span>ì´ ì œì¶œ</span>
                    <strong>{{ user_stats.total_attempts }}</strong>
                </li>
                <li>
                    <span>í•´ê²°</span>
                    <strong>{{ user_stats.total_solves }}</strong>
                </li>
                <li>
                    <span>ì •ë‹µë¥ </span>
                    <strong>{{ user_stats.accuracy }}%</strong>
                </li>
                <li>
                    <span>ëˆ„ì  í¬ì¸íŠ¸</span>
                    <strong>{{ user_stats.reward_points }}</strong>
                </li>
                <li>
                    <span>ì¦ê²¨ì°¾ëŠ” ì¹´í…Œê³ ë¦¬</span>
                    <strong>{{ user_stats.favorite_category or 'ë°ì´í„° ì—†ìŒ' }}</strong>
                </li>
            </ul>
        </section>
        {% endif %}

        <section class="card">
            <h3>TOP Solver</h3>
            <ul class="leaderboard">
                {% for row in leaderboard %}
                <li>
                    <span>#{{ loop.index }}</span>
                    <span>{{ row.username }}</span>
                    <span>{{ row.solved }} solved</span>
                </li>
                {% else %}
                <li class="empty-state">ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                {% endfor %}
            </ul>
        </section>

        <section class="card">
            <h3>ìµœê·¼ ì»¤ë®¤ë‹ˆí‹° ë¬¸ì œ</h3>
            <ul class="recent">
                {% for item in recent_creations %}
                <li>
                    <strong>{{ item.title }}</strong>
                    <span>{{ item.author_name }}</span>
                </li>
                {% else %}
                <li class="empty-state">ì»¤ë®¤ë‹ˆí‹° ë¬¸ì œë¥¼ ì²« ë“±ë¡í•´ë³´ì„¸ìš”.</li>
                {% endfor %}
            </ul>
        </section>

        {% if user_stats %}
        <section class="card">
            <h3>ìµœê·¼ ì œì¶œ ê¸°ë¡</h3>
            <ul class="attempt-log">
                {% for attempt in recent_attempts %}
                <li class="{% if attempt.is_correct %}correct{% else %}wrong{% endif %}">
                    <div class="attempt-head">
                        <strong>{{ attempt.challenge }}</strong>
                        <span class="difficulty">{{ attempt.difficulty }}</span>
                    </div>
                    <div class="attempt-body">
                        <span class="status">{% if attempt.is_correct %}ì •ë‹µ{% else %}ì˜¤ë‹µ{% endif %}</span>
                        {% set attempt_time = attempt.created_at %}
                        <time datetime="{{ attempt_time.isoformat() if attempt_time else '' }}">
                            {% if attempt_time %}{{ attempt_time.strftime('%m/%d %H:%M') }}{% else %}-{% endif %}
                        </time>
                    </div>
                    <p class="attempt-flag">{{ attempt.submitted_flag }}</p>
                </li>
                {% else %}
                <li class="empty-state">ì œì¶œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                {% endfor %}
            </ul>
        </section>
        {% endif %}
    </aside>
</section>

<section class="create-section" id="create-section">
    <header>
        <p class="eyebrow">Community Workshop</p>
        <h2>ë‚˜ë§Œì˜ ì›Œê²Œì„ ë¬¸ì œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h2>
        <p>ë‚´ë¶€ ê²€ìˆ˜ í›„ ì „ì²´ í”Œë ˆì´ì–´ì—ê²Œ ê³µê°œë©ë‹ˆë‹¤.</p>
    </header>
    <form method="post" action="{{ url_for('wargame.publish_challenge') }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-row">
            <label>
                ì œëª©
                <input type="text" name="title" placeholder="ì˜ˆ: Quantum Vault" required>
            </label>
            <label>
                ë‚œì´ë„
                <select name="difficulty">
                    <option value="ì´ˆê¸‰">ì´ˆê¸‰</option>
                    <option value="ì¤‘ê¸‰" selected>ì¤‘ê¸‰</option>
                    <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                </select>
            </label>
            <label>
                ì¹´í…Œê³ ë¦¬
                <input type="text" name="category" placeholder="Web / Crypto / Pwn">
            </label>
        </div>
        <label>
            ë¬¸ì œ ì„¤ëª…
            <textarea name="summary" rows="3" placeholder="ì‹œë‚˜ë¦¬ì˜¤ì™€ ìš”êµ¬ì‚¬í•­ì„ ì •ì˜í•´ì£¼ì„¸ìš”." required></textarea>
        </label>
        <div class="form-row">
            <label>
                FLAG ê°’
                <input type="text" name="flag" placeholder="FLAG{...}" required>
            </label>
            <label>
                íŒíŠ¸ (ì„ íƒ)
                <input type="text" name="hint" placeholder="ì§§ì€ íŒíŠ¸">
            </label>
        </div>
        <label class="file-upload">
            ì°¸ê³  ìë£Œ (ì„ íƒ)
            <input type="file" name="attachment" accept=".zip,.tar,.gz,.tgz,.bz2,.7z,.txt,.pdf,.md">
        </label>
        <p class="upload-note">ì••ì¶•/ë¬¸ì„œ íŒŒì¼ë§Œ í—ˆìš©ë˜ë©° ìµœëŒ€ 8MB ê¹Œì§€ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <button class="primary" type="submit">ë¬¸ì œ ì œì¶œ</button>
        {% if not g.user %}
        <p class="login-hint">ë¡œê·¸ì¸ í›„ ì œì¶œí•˜ë©´ ê²€ìˆ˜ê°€ ì§„í–‰ë©ë‹ˆë‹¤.</p>
        {% endif %}
    </form>
</section>
{% endblock %}
